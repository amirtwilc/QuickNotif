package app.amir.quicknotif;

import android.content.Context;
import android.content.Intent;
import android.content.SharedPreferences;
import android.widget.RemoteViews;
import android.widget.RemoteViewsService;

import org.json.JSONArray;
import org.json.JSONObject;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.TimeZone;

public class QuickNotifWidgetService extends RemoteViewsService {
    @Override
    public RemoteViewsFactory onGetViewFactory(Intent intent) {
        return new QuickNotifRemoteViewsFactory(this.getApplicationContext());
    }

    private static class QuickNotifRemoteViewsFactory implements RemoteViewsService.RemoteViewsFactory {
        private final Context context;
        private final List<NotificationData> notifications;

        QuickNotifRemoteViewsFactory(Context context) {
            this.context = context;
            this.notifications = new ArrayList<>();
        }

        @Override
        public void onCreate() {
            loadNotifications();
        }

        @Override
        public void onDataSetChanged() {
            loadNotifications();
        }

        @Override
        public void onDestroy() {
            notifications.clear();
        }

        @Override
        public int getCount() {
            return notifications.size();
        }

        @Override
        public RemoteViews getViewAt(int position) {
            RemoteViews rv = new RemoteViews(context.getPackageName(), R.layout.widget_item);
            if (position < notifications.size()) {
                NotificationData notification = notifications.get(position);
                rv.setTextViewText(R.id.notification_name, notification.name.isEmpty() ? "Unnamed" : notification.name);
                rv.setTextViewText(R.id.notification_time, notification.timeString);
                rv.setTextViewText(R.id.notification_date, notification.dateString);
            }
            return rv;
        }

        @Override
        public RemoteViews getLoadingView() {
            return null;
        }

        @Override
        public int getViewTypeCount() {
            return 1;
        }

        @Override
        public long getItemId(int position) {
            return position;
        }

        @Override
        public boolean hasStableIds() {
            return true;
        }

        private void loadNotifications() {
            notifications.clear();
            try {
                SharedPreferences prefs = context.getSharedPreferences("CapacitorStorage", Context.MODE_PRIVATE);
                String notificationsJson = prefs.getString("notifications", "[]");
                JSONArray array = new JSONArray(notificationsJson);
                SimpleDateFormat timeFormat = new SimpleDateFormat("HH:mm", Locale.getDefault());
                SimpleDateFormat dateFormat = new SimpleDateFormat("MMM d", Locale.getDefault());
                SimpleDateFormat isoFormat = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'", Locale.US);
                isoFormat.setTimeZone(TimeZone.getTimeZone("UTC"));
                
                List<NotificationData> tempNotifications = new ArrayList<>();

                for (int i = 0; i < array.length(); i++) {
                    JSONObject obj = array.getJSONObject(i);
                    boolean enabled = obj.optBoolean("enabled", false);

                    long scheduledAt = 0L;
                    try {
                        scheduledAt = obj.getLong("scheduledAt");
                    } catch (Exception e) {
                        String s = obj.optString("scheduledAt", null);
                        if (s != null && !s.isEmpty()) {
                            try {
                                Date parsed = isoFormat.parse(s);
                                if (parsed != null) scheduledAt = parsed.getTime();
                            } catch (Exception ignored2) { }
                        }
                    }

                    if (enabled && scheduledAt > System.currentTimeMillis()) {
                        String name = obj.optString("name", "");
                        String timeString = timeFormat.format(new Date(scheduledAt));
                        String dateString = dateFormat.format(new Date(scheduledAt));
                        tempNotifications.add(new NotificationData(name, timeString, dateString, scheduledAt));
                    }
                }
                
                // Sort by scheduled time (earliest first)
                Collections.sort(tempNotifications, new Comparator<NotificationData>() {
                    @Override
                    public int compare(NotificationData n1, NotificationData n2) {
                        return Long.compare(n1.scheduledAt, n2.scheduledAt);
                    }
                });
                
                notifications.addAll(tempNotifications);
            } catch (Exception ignored) { }
        }

        private static class NotificationData {
            final String name;
            final String timeString;
            final String dateString;
            final long scheduledAt;

            NotificationData(String name, String timeString, String dateString, long scheduledAt) {
                this.name = name;
                this.timeString = timeString;
                this.dateString = dateString;
                this.scheduledAt = scheduledAt;
            }
        }
    }
}
